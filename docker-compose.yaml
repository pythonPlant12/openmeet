services:
  # Frontend - Vue 3
  frontend:
    container_name: openmeet_frontend
    build:
      context: ./openmeet-client
      dockerfile: Dockerfile
    env_file:
      - ./openmeet-client/.env
    networks:
      - openmeet_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # SFU - Rust WebRTC (Selective Forwarding Unit)
  sfu:
    container_name: openmeet_sfu
    build:
      context: ./openmeet-server
      dockerfile: Dockerfile
    env_file:
      - ./openmeet-server/.env
    volumes:
      - ./certs:/app/certs:ro
    networks:
      - openmeet_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8081"]
      interval: 30s
      timeout: 5s
      retries: 3

  # TURN Server - CoTURN for NAT traversal
  coturn:
    container_name: openmeet_coturn
    image: coturn/coturn:latest
    network_mode: host
    env_file:
      - ./.env
    volumes:
      - ./deployment/coturn/turnserver.conf.template:/etc/turnserver.conf.template:ro
    restart: unless-stopped
    entrypoint: /bin/sh
    command:
      - -c
      - |
        envsubst < /etc/turnserver.conf.template > /tmp/turnserver.conf
        exec turnserver -c /tmp/turnserver.conf

  # Nginx - Reverse Proxy with SSL (internal, gateway handles external traffic)
  nginx:
    container_name: openmeet_nginx
    image: nginx:alpine
    # No ports exposed - gateway handles external traffic via SNI routing
    volumes:
      - ./deployment/nginx/openmeet.conf:/etc/nginx/conf.d/default.conf:ro
      # Certificates are managed by NT-Solutions certbot (shared gateway)
      # On VPS: /home/debian/nt-solutions/nginx/certbot/conf
      - /home/debian/nt-solutions/nginx/certbot/conf:/etc/letsencrypt:ro
    networks:
      - openmeet_network
      - shared_gateway_network
    depends_on:
      - frontend
      - sfu
    restart: unless-stopped

  # NOTE: Certbot is handled by the gateway in NT-Solutions
  # Certificates for openmeet.eu should be generated there

# Networks
networks:
  openmeet_network:
    name: openmeet_network
    driver: bridge
  shared_gateway_network:
    external: true
    name: shared_gateway_network
